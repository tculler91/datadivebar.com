<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Desk — Data Dive Bar</title>
    <meta name="description" content="Live Doppler radar and conditions for Ohio. Ambient weather display by Data Dive Bar.">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet.heat for traffic jam heatmap -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Fonts: VT323 for that CRT terminal glow, Playfair for city names -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:ital,wght@0,500;0,700;1,500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg:             #020510;
            --navy:           #04082a;
            --panel:          rgba(4, 8, 38, 0.94);
            --panel-border:   rgba(48, 148, 220, 0.18);
            --blue:           #3888c8;
            --teal:           #30c8d4;
            --teal-dim:       rgba(48, 200, 212, 0.12);
            --amber:          #e4a83c;
            --amber-bright:   #f0c060;
            --purple:         #8868c0;
            --text:           #b8d0f0;
            --text-secondary: #6888b0;
            --text-dim:       #2e4868;
            --bar-h:          54px;
            --chyron-h:       48px;
            --glow-blue:      0 0 8px rgba(48, 136, 200, 0.6), 0 0 20px rgba(48, 136, 200, 0.2);
            --glow-teal:      0 0 8px rgba(48, 200, 212, 0.7), 0 0 20px rgba(48, 200, 212, 0.25);
            --glow-amber:     0 0 8px rgba(228, 168, 60, 0.7), 0 0 24px rgba(228, 168, 60, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%; height: 100%;
            background: var(--bg);
            overflow: hidden;
            font-family: 'IBM Plex Mono', 'Courier New', monospace;
            -webkit-font-smoothing: antialiased;
        }

        /* ── MAP ─────────────────────────────────────────────── */
        #map {
            position: fixed;
            inset: 0;
            z-index: 1;
        }

        .leaflet-control-zoom,
        .leaflet-control-attribution { display: none !important; }

        /* ── CRT SCAN LINES ─────────────────────────────────── */
        .scanlines {
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 3px,
                rgba(0, 0, 8, 0.10) 3px,
                rgba(0, 0, 8, 0.10) 4px
            );
            pointer-events: none;
            z-index: 491;
        }

        /* ── FILM GRAIN ──────────────────────────────────────── */
        .grain {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 492;
            opacity: 0.028;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.78' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23g)' opacity='1'/%3E%3C/svg%3E");
            background-size: 300px 300px;
            animation: grain-shift 0.8s steps(1) infinite;
        }
        @keyframes grain-shift {
            0%   { background-position: 0 0; }
            20%  { background-position: -80px -40px; }
            40%  { background-position: 60px -90px; }
            60%  { background-position: -30px 70px; }
            80%  { background-position: 100px 20px; }
            100% { background-position: -50px -60px; }
        }

        /* ── VIGNETTE ────────────────────────────────────────── */
        .vignette {
            position: fixed;
            inset: 0;
            background: radial-gradient(
                ellipse at 50% 50%,
                transparent 38%,
                rgba(2, 5, 16, 0.45) 65%,
                rgba(2, 5, 16, 0.82) 100%
            );
            pointer-events: none;
            z-index: 493;
        }

        /* subtle CRT corner darkening */
        .vignette::after {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse 120% 140% at 0% 0%,   rgba(2,5,16,0.35) 0%, transparent 55%),
                radial-gradient(ellipse 120% 140% at 100% 0%,  rgba(2,5,16,0.35) 0%, transparent 55%),
                radial-gradient(ellipse 120% 140% at 0% 100%,  rgba(2,5,16,0.35) 0%, transparent 55%),
                radial-gradient(ellipse 120% 140% at 100% 100%,rgba(2,5,16,0.35) 0%, transparent 55%);
        }

        /* ── SUBTLE FLICKER ──────────────────────────────────── */
        .flicker-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 494;
            animation: crt-flicker 12s ease-in-out infinite;
            opacity: 0;
            background: rgba(180, 220, 255, 0.012);
        }
        @keyframes crt-flicker {
            0%, 92%, 100%   { opacity: 0; }
            93%             { opacity: 1; }
            93.5%           { opacity: 0; }
            94%             { opacity: 0.8; }
            94.5%           { opacity: 0; }
        }

        /* ── TOP BAR ─────────────────────────────────────────── */
        .top-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--bar-h);
            background: linear-gradient(to bottom, rgba(4,8,42,0.97), rgba(4,8,32,0.93));
            border-bottom: 1px solid rgba(48, 148, 220, 0.22);
            box-shadow: 0 1px 0 rgba(48, 200, 212, 0.08), 0 4px 24px rgba(2, 5, 16, 0.8);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 22px;
            z-index: 600;
        }

        /* left: logo bug */
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-bug {
            width: 32px; height: 32px;
            border: 1.5px solid rgba(48, 200, 212, 0.5);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            background: rgba(48, 200, 212, 0.07);
            box-shadow: var(--glow-teal), inset 0 0 8px rgba(48,200,212,0.05);
            flex-shrink: 0;
        }
        .logo-text { display: flex; flex-direction: column; gap: 2px; }
        .logo-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 0.92rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: 0.04em;
            line-height: 1.1;
            text-shadow: 0 0 12px rgba(48, 200, 212, 0.3);
        }
        .logo-sub {
            font-family: 'VT323', monospace;
            font-size: 0.75rem;
            color: var(--teal);
            letter-spacing: 0.16em;
            text-transform: uppercase;
            text-shadow: var(--glow-teal);
            opacity: 0.85;
        }

        /* center: LIVE / LOCAL ON THE 8s */
        .top-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        .top-center-main {
            font-family: 'VT323', monospace;
            font-size: 1.0rem;
            color: var(--teal);
            letter-spacing: 0.22em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: var(--glow-teal);
        }
        .live-dot {
            width: 7px; height: 7px;
            background: #e84040;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 0 6px rgba(232, 64, 64, 0.8), 0 0 14px rgba(232, 64, 64, 0.4);
            animation: livepulse 2s ease-in-out infinite;
        }
        @keyframes livepulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 6px rgba(232,64,64,0.9), 0 0 14px rgba(232,64,64,0.5); }
            50%       { opacity: 0.5; box-shadow: 0 0 3px rgba(232,64,64,0.4); }
        }
        .top-center-sub {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.50rem;
            font-weight: 500;
            color: var(--text-dim);
            letter-spacing: 0.14em;
            text-transform: uppercase;
            margin-top: 3px;
        }

        /* right: clock */
        .clock-area { text-align: right; }
        #clock {
            font-family: 'VT323', monospace;
            font-size: 1.7rem;
            color: var(--amber-bright);
            letter-spacing: 0.06em;
            line-height: 1;
            text-shadow: var(--glow-amber);
        }
        #date-display {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.50rem;
            font-weight: 500;
            color: var(--text-dim);
            letter-spacing: 0.14em;
            text-transform: uppercase;
            margin-top: 3px;
        }

        /* ── NOW VIEWING OVERLAY ─────────────────────────────── */
        .now-viewing {
            position: fixed;
            top: calc(var(--bar-h) + 14px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(4, 8, 42, 0.88);
            border: 1px solid rgba(48, 148, 220, 0.35);
            border-radius: 3px;
            padding: 6px 20px;
            z-index: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            opacity: 0;
            transition: opacity 1.2s ease;
            pointer-events: none;
        }
        .now-viewing.visible { opacity: 1; }
        .now-viewing-label {
            font-family: 'VT323', monospace;
            font-size: 0.68rem;
            color: var(--text-dim);
            letter-spacing: 0.22em;
            text-transform: uppercase;
        }
        .now-viewing-name {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.1rem;
            font-weight: 700;
            font-style: italic;
            color: var(--amber);
            letter-spacing: 0.05em;
            text-shadow: var(--glow-amber);
        }

        /* ── CONTROLS (bottom-left) ──────────────────────────── */
        .controls {
            position: fixed;
            bottom: calc(var(--chyron-h) + 14px);
            left: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 600;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-label {
            font-family: 'VT323', monospace;
            font-size: 0.85rem;
            color: var(--text-dim);
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }
        .segmented {
            background: rgba(4, 8, 42, 0.88);
            border: 1px solid rgba(48, 148, 220, 0.2);
            border-radius: 3px;
            padding: 3px;
            display: inline-flex;
            gap: 2px;
        }
        .seg-btn {
            background: transparent;
            border: none;
            border-radius: 2px;
            color: var(--text-dim);
            font-family: 'VT323', monospace;
            font-size: 0.9rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 3px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .seg-btn:hover { color: var(--text-secondary); }
        .seg-btn.active {
            background: rgba(48, 200, 212, 0.12);
            color: var(--teal);
            text-shadow: var(--glow-teal);
        }

        .audio-btn {
            background: rgba(4, 8, 42, 0.88);
            border: 1px solid rgba(48, 148, 220, 0.2);
            border-radius: 3px;
            color: var(--text-dim);
            font-family: 'VT323', monospace;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            padding: 6px 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .audio-btn:hover {
            color: var(--text-secondary);
            border-color: rgba(48, 200, 212, 0.3);
        }
        .audio-btn.active {
            color: var(--teal);
            border-color: rgba(48, 200, 212, 0.35);
            text-shadow: var(--glow-teal);
        }

        /* ── RADAR LEGEND (bottom-right) ─────────────────────── */
        .radar-legend {
            position: fixed;
            bottom: calc(var(--chyron-h) + 14px);
            right: 14px;
            z-index: 600;
            background: rgba(4, 8, 42, 0.88);
            border: 1px solid rgba(48, 148, 220, 0.2);
            border-radius: 3px;
            padding: 9px 13px;
        }
        .radar-legend-title {
            font-family: 'VT323', monospace;
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 0.18em;
            text-transform: uppercase;
            margin-bottom: 7px;
        }
        .radar-legend-bar {
            width: 140px;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right,
                #04e9e7 0%,
                #019ff4 11%,
                #0300f4 22%,
                #02fd02 33%,
                #01c501 44%,
                #fdf802 55%,
                #e5bc00 62%,
                #fd9500 70%,
                #fd0000 80%,
                #bc0000 90%,
                #f800fd 100%
            );
        }
        .radar-legend-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        .radar-legend-label {
            font-family: 'VT323', monospace;
            font-size: 0.65rem;
            color: var(--text-dim);
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        /* ── CITY MAP MARKERS ────────────────────────────────── */
        .city-marker {
            background: rgba(4, 8, 42, 0.92);
            border: 1px solid rgba(48, 148, 220, 0.4);
            border-radius: 3px;
            padding: 4px 9px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.7), var(--glow-blue);
            white-space: nowrap;
        }
        .city-marker-name {
            font-family: 'VT323', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            letter-spacing: 0.14em;
            text-transform: uppercase;
            line-height: 1;
        }
        .city-marker-row {
            display: flex;
            align-items: center;
            gap: 4px;
            line-height: 1;
        }
        .city-marker-icon { font-size: 0.72rem; }
        .city-marker-temp {
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            font-weight: 400;
            line-height: 1;
        }

        /* ── SCROLLING CHYRON ────────────────────────────────── */
        .chyron-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--chyron-h);
            background: linear-gradient(to bottom, rgba(3,6,34,0.98), rgba(2,4,26,0.99));
            border-top: 1.5px solid var(--blue);
            box-shadow: 0 -1px 0 rgba(48,200,212,0.08), 0 -8px 32px rgba(2,5,16,0.9);
            display: flex;
            align-items: center;
            z-index: 600;
            overflow: hidden;
        }

        .chyron-label {
            background: var(--blue);
            color: #ffffff;
            font-family: 'VT323', monospace;
            font-size: 0.95rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            padding: 0 16px;
            height: 100%;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.15);
            box-shadow: 2px 0 12px rgba(56,136,200,0.4);
        }

        .chyron-scroll-mask {
            flex: 1;
            overflow: hidden;
            height: 100%;
            display: flex;
            align-items: center;
            position: relative;
        }
        /* left fade */
        .chyron-scroll-mask::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 40px;
            background: linear-gradient(to right, rgba(3,6,34,0.98), transparent);
            z-index: 1;
            pointer-events: none;
        }

        .chyron-scroll {
            display: flex;
            align-items: center;
            white-space: nowrap;
            will-change: transform;
        }

        .chyron-city {
            display: inline-flex;
            align-items: center;
            gap: 0;
            padding: 0 28px;
        }
        .chyron-city-name {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--amber);
            letter-spacing: 0.04em;
            margin-right: 10px;
            text-shadow: var(--glow-amber);
        }
        .chyron-city-data {
            font-family: 'VT323', monospace;
            font-size: 1.0rem;
            color: var(--text);
            letter-spacing: 0.06em;
            text-shadow: 0 0 8px rgba(184, 208, 240, 0.3);
        }
        .chyron-sep {
            color: var(--teal);
            font-family: 'VT323', monospace;
            font-size: 1.0rem;
            padding: 0 4px;
            opacity: 0.6;
            text-shadow: var(--glow-teal);
        }
        .chyron-divider {
            color: var(--blue);
            font-family: 'VT323', monospace;
            font-size: 1.4rem;
            opacity: 0.5;
            padding: 0 8px;
        }
        .chyron-loading {
            font-family: 'VT323', monospace;
            font-size: 1.0rem;
            color: var(--text-dim);
            letter-spacing: 0.18em;
            padding: 0 20px;
            animation: chyron-blink 1.4s ease-in-out infinite;
        }
        @keyframes chyron-blink {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* ── ALERT BANNER ────────────────────────────────────── */
        .alert-banner {
            position: fixed;
            top: var(--bar-h);
            left: 0; right: 0;
            background: rgba(50, 8, 8, 0.95);
            border-bottom: 1.5px solid rgba(255, 60, 40, 0.35);
            box-shadow: 0 2px 20px rgba(232, 64, 64, 0.2);
            color: #ff8888;
            font-family: 'VT323', monospace;
            font-size: 0.9rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            padding: 7px 22px;
            z-index: 650;
            display: none;
        }

        /* ── SPLASH SCREEN ───────────────────────────────────────── */
        #splash {
            position: fixed;
            inset: 0;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(2, 5, 16, 0.92);
            cursor: pointer;
            gap: 18px;
            transition: opacity 0.6s ease;
        }
        #splash.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .splash-logo {
            font-size: 2.8rem;
            opacity: 0.6;
        }
        .splash-title {
            font-family: 'VT323', monospace;
            font-size: clamp(1.6rem, 5vw, 2.4rem);
            color: var(--teal);
            letter-spacing: 0.18em;
            text-transform: uppercase;
            text-shadow: var(--glow-teal);
        }
        .splash-sub {
            font-family: 'VT323', monospace;
            font-size: clamp(1rem, 3vw, 1.35rem);
            color: var(--text-secondary);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        .splash-cta {
            margin-top: 24px;
            font-family: 'VT323', monospace;
            font-size: clamp(1.1rem, 3.5vw, 1.5rem);
            color: var(--amber-bright);
            letter-spacing: 0.22em;
            text-transform: uppercase;
            animation: splash-pulse 1.6s ease-in-out infinite;
            text-shadow: 0 0 12px rgba(240, 192, 96, 0.7);
        }
        @keyframes splash-pulse {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.35; }
        }
        .alert-banner.visible { display: flex; align-items: center; gap: 10px; }
        .alert-icon {
            color: #ff5050;
            font-size: 1rem;
            animation: livepulse 1s ease-in-out infinite;
        }

        /* ── TRAFFIC MARKERS ─────────────────────────────────── */
        .traffic-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1.5px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.72rem;
            background: rgba(4, 8, 42, 0.9);
            line-height: 1;
            cursor: pointer;
        }
        .traffic-marker.police   { border-color: #3888c8; box-shadow: 0 0 8px rgba(56,136,200,0.8), 0 0 20px rgba(56,136,200,0.3); }
        .traffic-marker.accident { border-color: #e84040; box-shadow: 0 0 8px rgba(232,64,64,0.8), 0 0 20px rgba(232,64,64,0.3); }
        .traffic-marker.hazard   { border-color: #e4a83c; box-shadow: 0 0 8px rgba(228,168,60,0.8), 0 0 20px rgba(228,168,60,0.3); }
        .traffic-marker.closure  { border-color: #e87050; box-shadow: 0 0 8px rgba(232,112,80,0.8), 0 0 20px rgba(232,112,80,0.3); }

        /* ── LEAFLET POPUP (dark theme) ───────────────────────── */
        .leaflet-popup-content-wrapper {
            background: rgba(4, 8, 42, 0.96);
            border: 1px solid rgba(48, 148, 220, 0.35);
            border-radius: 3px;
            padding: 0;
            box-shadow: 0 2px 16px rgba(0,0,0,0.85), 0 0 12px rgba(48,136,200,0.15);
            color: var(--text);
        }
        .leaflet-popup-content {
            margin: 8px 12px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.72rem;
            line-height: 1.5;
        }
        .leaflet-popup-tip-container { display: none; }
        .leaflet-popup-close-button { display: none; }

        /* ── TRAFFIC LEGEND ──────────────────────────────────── */
        .traffic-legend {
            position: fixed;
            bottom: calc(var(--chyron-h) + 92px);
            right: 14px;
            z-index: 600;
            background: rgba(4, 8, 42, 0.88);
            border: 1px solid rgba(48, 148, 220, 0.2);
            border-radius: 3px;
            padding: 9px 13px;
            display: none;
        }
        .traffic-legend.visible { display: block; }
        .traffic-legend-title {
            font-family: 'VT323', monospace;
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 0.18em;
            text-transform: uppercase;
            margin-bottom: 7px;
        }
        .traffic-legend-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 7px;
        }
        .traffic-legend-item {
            display: flex;
            align-items: center;
            gap: 7px;
        }
        .traffic-legend-icon { font-size: 0.8rem; width: 16px; text-align: center; }
        .traffic-legend-label {
            font-family: 'VT323', monospace;
            font-size: 0.68rem;
            color: var(--text-secondary);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        #traffic-status {
            font-family: 'VT323', monospace;
            font-size: 0.65rem;
            color: var(--text-dim);
            letter-spacing: 0.1em;
            border-top: 1px solid rgba(48,148,220,0.12);
            padding-top: 6px;
            margin-top: 2px;
        }

        /* ── RESPONSIVE ──────────────────────────────────────── */
        @media (max-width: 900px) {
            .chyron-city { padding: 0 18px; }
        }
        @media (max-width: 640px) {
            .top-bar { padding: 0 12px; }
            .top-center { display: none; }
            #clock { font-size: 1.4rem; }
            .controls { bottom: calc(var(--chyron-h) + 8px); left: 8px; }
            .radar-legend { display: none; }
            .now-viewing { display: none; }
        }
    </style>
</head>
<body>

    <!-- CRT effects layered bottom to top -->
    <div class="scanlines"></div>
    <!-- Splash screen — satisfies browser autoplay gate for audio + animations -->
    <div id="splash">
        <div class="splash-logo">&#9928;</div>
        <div class="splash-title">Weather Desk</div>
        <div class="splash-sub">Ohio Doppler &bull; Data Dive Bar</div>
        <div class="splash-cta">Tap to Tune In</div>
    </div>

    <div class="grain"></div>
    <div class="vignette"></div>
    <div class="flicker-overlay"></div>

    <div id="map"></div>

    <!-- Alert banner -->
    <div class="alert-banner" id="alert-banner">
        <span class="alert-icon">&#9888;</span>
        <span id="alert-text"></span>
    </div>

    <!-- Top bar -->
    <div class="top-bar">
        <div class="logo">
            <div class="logo-bug">&#9928;</div>
            <div class="logo-text">
                <div class="logo-title">Weather Desk</div>
                <div class="logo-sub">Ohio Doppler</div>
            </div>
        </div>

        <div class="top-center">
            <div class="top-center-main">
                <span class="live-dot"></span>
                DATA DIVE BAR &bull; LOCAL ON THE 8s
            </div>
            <div class="top-center-sub" id="updated-display">&nbsp;</div>
        </div>

        <div class="clock-area">
            <div id="clock">12:00 AM</div>
            <div id="date-display">Loading&hellip;</div>
        </div>
    </div>

    <!-- Now Viewing overlay -->
    <div class="now-viewing" id="now-viewing">
        <div class="now-viewing-label">Now Viewing</div>
        <div class="now-viewing-name" id="now-viewing-name">Ohio Overview</div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="control-group">
            <span class="control-label">Radar</span>
            <div class="segmented" id="radar-seg">
                <button class="seg-btn active" data-opacity="0.72">On</button>
                <button class="seg-btn" data-opacity="0.35">50%</button>
                <button class="seg-btn" data-opacity="0.10">10%</button>
                <button class="seg-btn" data-opacity="0">Off</button>
            </div>
        </div>
        <div class="control-group">
            <span class="control-label">Traffic</span>
            <div class="segmented" id="traffic-seg">
                <button class="seg-btn" data-traffic="on">On</button>
                <button class="seg-btn active" data-traffic="off">Off</button>
            </div>
        </div>
        <button class="audio-btn" id="audio-btn">&#9834; Play Sax</button>
    </div>

    <!-- Radar legend -->
    <div class="radar-legend">
        <div class="radar-legend-title">Radar Intensity</div>
        <div class="radar-legend-bar"></div>
        <div class="radar-legend-labels">
            <span class="radar-legend-label">Light</span>
            <span class="radar-legend-label">Moderate</span>
            <span class="radar-legend-label">Heavy</span>
        </div>
    </div>

    <!-- Traffic legend -->
    <div class="traffic-legend" id="traffic-legend">
        <div class="traffic-legend-title">Traffic Alerts</div>
        <div class="traffic-legend-items">
            <div class="traffic-legend-item">
                <span class="traffic-legend-icon">&#x1F694;</span>
                <span class="traffic-legend-label">Police</span>
            </div>
            <div class="traffic-legend-item">
                <span class="traffic-legend-icon">&#x1F4A5;</span>
                <span class="traffic-legend-label">Accident</span>
            </div>
            <div class="traffic-legend-item">
                <span class="traffic-legend-icon">&#x26A0;&#xFE0F;</span>
                <span class="traffic-legend-label">Hazard</span>
            </div>
            <div class="traffic-legend-item">
                <span class="traffic-legend-icon">&#x1F6A7;</span>
                <span class="traffic-legend-label">Road Closed</span>
            </div>
        </div>
        <div id="traffic-status">&#x2014; Inactive &#x2014;</div>
    </div>

    <!-- Audio -->
    <!-- Jazz24 (KNKX Seattle): smooth jazz, free, no key required -->
    <audio id="jazz-audio" preload="none"></audio>

    <!-- Scrolling chyron -->
    <div class="chyron-bar">
        <div class="chyron-label">Conditions</div>
        <div class="chyron-scroll-mask">
            <div class="chyron-scroll" id="chyron-scroll">
                <span class="chyron-loading">Acquiring signal&hellip;</span>
            </div>
        </div>
    </div>

    <script>
    // ══════════════════════════════════════════════════════════════
    //  DATA DIVE BAR — WEATHER DESK — OHIO DOPPLER
    //  90s Weather Channel ASMR Experience
    // ══════════════════════════════════════════════════════════════

    var RADAR_REFRESH_MS   = 2.5 * 60 * 1000;
    var ALERT_CHECK_MS     = 5   * 60 * 1000;
    var WEATHER_REFRESH_MS = 10  * 60 * 1000;
    var NWS_UA = 'DataDiveBarWeatherDesk/1.0 github.com/datadivebar';

    var WEATHER_STATIONS = [
        { id: 'KCMH', name: 'Columbus',   lat: 39.9612, lng: -82.9988 },
        { id: 'KCLE', name: 'Cleveland',  lat: 41.4993, lng: -81.6944 },
        { id: 'KCVG', name: 'Cincinnati', lat: 39.1031, lng: -84.5120 },
        { id: 'KTOL', name: 'Toledo',     lat: 41.6528, lng: -83.5379 },
        { id: 'KAKR', name: 'Akron',      lat: 41.0814, lng: -81.5190 },
    ];

    // ── CAMERA DIRECTOR ──────────────────────────────────────────
    // Slow dreamy panning across Ohio — the heart of the ASMR experience
    var CAMERA_SHOTS = [
        // ── Ohio statewide passes ──────────────────────────────────
        { label: 'Ohio Overview',         lat: 40.4173, lng: -82.9071, zoom: 7,  dwell: 32000 },

        // ── Greater Columbus Metro — Dayton ↔ Zanesville / Mansfield ↔ Chillicothe ──
        { label: 'Central Ohio Corridor', lat: 39.96,   lng: -83.30,  zoom: 8,  dwell: 28000 },
        { label: 'Columbus',              lat: 39.9612, lng: -82.9988, zoom: 10, dwell: 22000 },
        { label: 'Columbus — Downtown',   lat: 39.9600, lng: -83.0007, zoom: 12, dwell: 18000 },
        { label: 'Worthington / Dublin',  lat: 40.0900, lng: -83.0680, zoom: 11, dwell: 18000 },
        { label: 'Westerville / Easton',  lat: 40.1000, lng: -82.9000, zoom: 11, dwell: 18000 },
        { label: 'Grove City / Hilliard', lat: 39.8800, lng: -83.0750, zoom: 11, dwell: 18000 },
        { label: 'Pickerington / Canal',  lat: 39.9000, lng: -82.7600, zoom: 11, dwell: 18000 },
        { label: 'Newark',                lat: 40.0584, lng: -82.4013, zoom: 10, dwell: 20000 },
        { label: 'Zanesville',            lat: 39.9403, lng: -82.0132, zoom: 10, dwell: 20000 },
        { label: 'Mansfield',             lat: 40.7584, lng: -82.5154, zoom: 10, dwell: 20000 },
        { label: 'Lancaster',             lat: 39.7137, lng: -82.5996, zoom: 10, dwell: 18000 },
        { label: 'Chillicothe',           lat: 39.3331, lng: -82.9824, zoom: 10, dwell: 20000 },
        { label: 'Springfield',           lat: 39.9242, lng: -83.8088, zoom: 10, dwell: 18000 },
        { label: 'Dayton',                lat: 39.7589, lng: -84.1916, zoom: 10, dwell: 22000 },
        { label: 'Dayton — Downtown',     lat: 39.7590, lng: -84.1920, zoom: 12, dwell: 18000 },

        // ── Rest of Ohio ───────────────────────────────────────────
        { label: 'Northeast Ohio',        lat: 41.3,    lng: -81.2,   zoom: 8,  dwell: 26000 },
        { label: 'Cleveland',             lat: 41.4993, lng: -81.6944, zoom: 9,  dwell: 22000 },
        { label: 'Akron / Canton',        lat: 40.9,    lng: -81.55,  zoom: 9,  dwell: 22000 },
        { label: 'Toledo',                lat: 41.6528, lng: -83.5379, zoom: 9,  dwell: 22000 },
        { label: 'Northwest Ohio',        lat: 41.2,    lng: -83.8,   zoom: 8,  dwell: 26000 },
        { label: 'Cincinnati',            lat: 39.1031, lng: -84.5120, zoom: 9,  dwell: 22000 },
        { label: 'Southwest Ohio',        lat: 39.5,    lng: -84.1,   zoom: 8,  dwell: 26000 },
        { label: 'Southeast Ohio',        lat: 39.4,    lng: -82.0,   zoom: 8,  dwell: 26000 },
    ];

    var currentShot = 0;
    var cameraTimer = null;
    var nowViewingEl = document.getElementById('now-viewing');
    var nowViewingName = document.getElementById('now-viewing-name');

    // ── MAP ──────────────────────────────────────────────────────
    var map = L.map('map', {
        center: [40.4173, -82.9071],
        zoom: 7,
        zoomControl: false,
        attributionControl: false,
        zoomAnimation: true,
        fadeAnimation: true,
    });

    // Basemap pane — keep dark map atmospheric, just slightly brighter
    map.createPane('basemapPane');
    map.getPane('basemapPane').style.zIndex = 150;
    map.getPane('basemapPane').style.filter = 'brightness(1.55) contrast(1.08) saturate(0.7) hue-rotate(10deg)';

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        maxZoom: 19,
        pane: 'basemapPane',
    }).addTo(map);

    // Redraw heatmap after pan/zoom so colors stay locked to the correct roads
    map.on('moveend zoomend', function() {
        if (trafficHeatLayer) { trafficHeatLayer.redraw(); }
    });

    // ── RADAR LAYER ──────────────────────────────────────────────
    var radarLayer = L.tileLayer(
        'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png?_=' + Date.now(),
        { opacity: 0.72, maxNativeZoom: 8, maxZoom: 19 }
    ).addTo(map);

    function refreshRadar() {
        radarLayer.setUrl(
            'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png?_=' + Date.now()
        );
    }
    setInterval(refreshRadar, RADAR_REFRESH_MS);

    // ── RADAR CONTROLS ───────────────────────────────────────────
    document.querySelectorAll('#radar-seg .seg-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#radar-seg .seg-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            radarLayer.setOpacity(parseFloat(btn.dataset.opacity));
        });
    });

    // ── CAMERA DIRECTOR ──────────────────────────────────────────
    function showNowViewing(label) {
        nowViewingName.textContent = label;
        nowViewingEl.classList.add('visible');
        setTimeout(function() { nowViewingEl.classList.remove('visible'); }, 4500);
    }

    function flyToShot(index) {
        var shot = CAMERA_SHOTS[index];
        map.flyTo([shot.lat, shot.lng], shot.zoom, {
            duration: 3.5,
            easeLinearity: 0.18,
        });
        showNowViewing(shot.label);
        clearTimeout(cameraTimer);
        cameraTimer = setTimeout(function() {
            currentShot = (currentShot + 1) % CAMERA_SHOTS.length;
            flyToShot(currentShot);
        }, shot.dwell);
    }

    // Camera starts via splash dismiss (see below)

    // ── CLOCK ────────────────────────────────────────────────────
    var DAYS   = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    var MONTHS = ['January','February','March','April','May','June',
                  'July','August','September','October','November','December'];

    function updateClock() {
        var now = new Date();
        var h = now.getHours();
        var m = String(now.getMinutes()).padStart(2, '0');
        var ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        document.getElementById('clock').textContent = h + ':' + m + ' ' + ampm;
        document.getElementById('date-display').textContent =
            DAYS[now.getDay()] + ' \xB7 ' + MONTHS[now.getMonth()] + ' ' + now.getDate() + ', ' + now.getFullYear();
    }
    updateClock();
    setInterval(updateClock, 1000);

    // ── CONDITION ICON ───────────────────────────────────────────
    function getConditionIcon(desc) {
        if (!desc) return '\uD83C\uDF21\uFE0F';
        var d = desc.toLowerCase();
        if (d.includes('thunder') || d.includes('tstm'))              return '\u26C8\uFE0F';
        if (d.includes('blizzard'))                                    return '\u2744\uFE0F';
        if (d.includes('snow') || d.includes('flurr'))                return '\uD83C\uDF28\uFE0F';
        if (d.includes('sleet') || d.includes('freezing'))            return '\uD83C\uDF27\uFE0F';
        if (d.includes('rain') || d.includes('shower') || d.includes('drizzle')) return '\uD83C\uDF27\uFE0F';
        if (d.includes('fog') || d.includes('mist') || d.includes('haze'))       return '\uD83C\uDF2B\uFE0F';
        if (d.includes('partly') || d.includes('mostly sunny'))       return '\u26C5';
        if (d.includes('cloud') || d.includes('overcast'))            return '\u2601\uFE0F';
        if (d.includes('clear') || d.includes('sunny') || d.includes('fair'))    return '\u2600\uFE0F';
        if (d.includes('wind') || d.includes('breezy') || d.includes('gust'))    return '\uD83D\uDCA8';
        return '\uD83C\uDF21\uFE0F';
    }

    // ── TEMPERATURE COLOR ────────────────────────────────────────
    function getTempColor(tempF) {
        if (tempF == null) return 'var(--text-dim)';
        if (tempF < 20)  return '#7ab4f5';
        if (tempF < 32)  return '#4ab8d8';
        if (tempF < 50)  return '#5ab8aa';
        if (tempF < 68)  return '#88c870';
        if (tempF < 85)  return '#e4a83c';
        return '#e87050';
    }

    // ── NWS ALERTS ───────────────────────────────────────────────
    async function fetchAlerts() {
        try {
            var res = await fetch('https://api.weather.gov/alerts/active?area=OH', {
                headers: { 'User-Agent': NWS_UA, 'Accept': 'application/geo+json' }
            });
            if (!res.ok) return;
            var data = await res.json();
            var severe = (data.features || []).filter(function(f) {
                var ev = (f.properties.event || '').toLowerCase();
                return ev.includes('tornado') || ev.includes('severe') || ev.includes('flash flood');
            });
            var banner = document.getElementById('alert-banner');
            var alertText = document.getElementById('alert-text');
            if (severe.length > 0 && banner && alertText) {
                alertText.textContent = (severe[0].properties.headline || 'SEVERE WEATHER ALERT').toUpperCase();
                banner.classList.add('visible');
            } else if (banner) {
                banner.classList.remove('visible');
            }
        } catch(e) {}
    }
    fetchAlerts();
    setInterval(fetchAlerts, ALERT_CHECK_MS);

    // ── WEATHER DATA ─────────────────────────────────────────────
    var weatherData = [];
    var cityMarkers = [];
    var lastUpdated = null;

    function cToF(c)    { return c != null ? Math.round(c * 9/5 + 32) : null; }
    function msToMph(ms){ return ms != null ? Math.round(ms * 2.23694) : null; }
    function degToDir(deg) {
        if (deg == null) return '';
        var dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
        return dirs[Math.round(deg / 22.5) % 16];
    }

    // ── CITY MAP MARKERS ─────────────────────────────────────────
    function updateMapMarkers(data) {
        cityMarkers.forEach(function(m) { map.removeLayer(m); });
        cityMarkers = [];
        WEATHER_STATIONS.forEach(function(station, i) {
            var d = data[i];
            var tempF   = d ? d.tempF : null;
            var desc    = d ? d.desc  : '';
            var tempStr = tempF != null ? tempF + '\xB0F' : '\u2014';
            var icon    = getConditionIcon(desc);
            var color   = getTempColor(tempF);
            var marker = L.marker([station.lat, station.lng], {
                icon: L.divIcon({
                    className: '',
                    html: '<div class="city-marker">' +
                          '<div class="city-marker-name">' + station.name + '</div>' +
                          '<div class="city-marker-row">' +
                          '<span class="city-marker-icon">' + icon + '</span>' +
                          '<span class="city-marker-temp" style="color:' + color + '">' + tempStr + '</span>' +
                          '</div></div>',
                    iconSize: [88, 42],
                    iconAnchor: [44, 21],
                }),
                interactive: false,
            }).addTo(map);
            cityMarkers.push(marker);
        });
    }

    async function fetchWeather() {
        var results = [];
        for (var i = 0; i < WEATHER_STATIONS.length; i++) {
            var s = WEATHER_STATIONS[i];
            try {
                var res = await fetch('https://api.weather.gov/stations/' + s.id + '/observations/latest', {
                    headers: { 'User-Agent': NWS_UA, 'Accept': 'application/geo+json' }
                });
                if (!res.ok) throw new Error();
                var obs = (await res.json()).properties;
                results.push({
                    name:    s.name,
                    tempF:   cToF(obs.temperature && obs.temperature.value),
                    humid:   obs.relativeHumidity && obs.relativeHumidity.value != null
                             ? Math.round(obs.relativeHumidity.value) : null,
                    windMph: msToMph(obs.windSpeed && obs.windSpeed.value),
                    windDir: degToDir(obs.windDirection && obs.windDirection.value),
                    desc:    obs.textDescription || '',
                });
            } catch(e) {
                results.push({ name: s.name, tempF: null, humid: null, windMph: null, windDir: '', desc: '' });
            }
        }
        weatherData = results;
        lastUpdated = new Date();
        updateMapMarkers(results);
        renderChyron(results);
        updateTimestamp();
    }

    // ── LAST UPDATED ─────────────────────────────────────────────
    function updateTimestamp() {
        var el = document.getElementById('updated-display');
        if (!el || !lastUpdated) return;
        var mins = Math.floor((Date.now() - lastUpdated.getTime()) / 60000);
        el.textContent = mins < 1 ? 'Conditions updated just now' : 'Updated ' + mins + ' min ago';
    }
    setInterval(updateTimestamp, 30000);

    // ── SCROLLING CHYRON ─────────────────────────────────────────
    function renderChyron(data) {
        var scroll = document.getElementById('chyron-scroll');
        if (!scroll) return;

        // Build two copies for seamless loop
        var html = '';
        for (var pass = 0; pass < 2; pass++) {
            data.forEach(function(d, i) {
                var tempStr  = d.tempF != null ? d.tempF + '\xB0F' : '\u2014';
                var color    = getTempColor(d.tempF);
                var desc     = d.desc || 'No data';
                var wind     = d.windMph != null
                    ? (d.windDir ? d.windDir + ' ' : '') + d.windMph + ' mph'
                    : 'Calm';
                var humid    = d.humid != null ? d.humid + '%' : '\u2014';
                var icon     = getConditionIcon(d.desc);

                html +=
                    '<span class="chyron-city">' +
                    '<span class="chyron-city-name">' + d.name + '</span>' +
                    '<span class="chyron-city-data">' + icon + ' ' +
                    '<span style="color:' + color + '">' + tempStr + '</span>' +
                    '<span class="chyron-sep"> · </span>' + desc +
                    '<span class="chyron-sep"> · </span>Wind ' + wind +
                    '<span class="chyron-sep"> · </span>Hum ' + humid +
                    '</span>' +
                    '</span>' +
                    '<span class="chyron-divider">&#9475;</span>';
            });
        }
        scroll.innerHTML = html;
        startChyronAnimation(scroll);
    }

    var chyronAnimId = null;
    var chyronPos = null;

    function startChyronAnimation(el) {
        if (chyronAnimId) cancelAnimationFrame(chyronAnimId);

        // pixels per second — slow and dreamy
        var speed = 38;
        var halfWidth = null;
        var lastTime = null;

        if (chyronPos === null) {
            chyronPos = 0;
        }

        function animate(timestamp) {
            if (!lastTime) lastTime = timestamp;
            var delta = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            // Measure half-width on first frame after render
            if (halfWidth === null) {
                halfWidth = el.scrollWidth / 2;
            }

            chyronPos += speed * delta;
            if (chyronPos >= halfWidth) {
                chyronPos -= halfWidth;
            }
            el.style.transform = 'translateX(-' + chyronPos + 'px)';
            chyronAnimId = requestAnimationFrame(animate);
        }
        chyronAnimId = requestAnimationFrame(animate);
    }

    // ── SKELETON MARKERS ─────────────────────────────────────────
    updateMapMarkers(WEATHER_STATIONS.map(function(s) {
        return { name: s.name, tempF: null, desc: '', humid: null, windMph: null, windDir: '' };
    }));

    fetchWeather();
    setInterval(fetchWeather, WEATHER_REFRESH_MS);

    // ── AUDIO ────────────────────────────────────────────────────
    var audio    = document.getElementById('jazz-audio');
    var audioBtn = document.getElementById('audio-btn');
    audio.volume = 0.38;

    // Jazz24 (KNKX Seattle) — smooth jazz, confirmed working CDN URLs
    // amperwave.net = Jazz24's official streaming CDN (confirmed Oct 2023)
    // audiocdn.com  = URLs from jazz24.org's own web player
    // WBGO fallback = Jazz 88.3 Newark (official stream URLs)
    var streams = [
        'https://live.amperwave.net/direct/ppm-jazz24mp3-ibc1',
        'https://live.amperwave.net/direct/ppm-jazz24aac256-ibc1',
        'https://knkx-live-a.edge.audiocdn.com/6285_128k',
        'https://knkx-live-a.edge.audiocdn.com/6285_256k',
        'https://ais-sa8.cdnstream1.com/3629_128.mp3',
    ];
    var streamIndex = 0;
    var isPlaying = false;
    var autoplayBlocked = false;

    function setAudioState(state) {
        var labels = {
            idle:    '\u266A Play Sax',
            playing: '\u266A Mute',
            muted:   '\u266A Unmute',
            error:   '\u266A No Signal',
            loading: '\u266A Tuning\u2026',
        };
        audioBtn.textContent = labels[state] || labels.idle;
        audioBtn.classList.toggle('active', state === 'playing');
    }

    function tryPlay(index) {
        if (index === undefined) index = 0;
        streamIndex = index;
        setAudioState('loading');
        audio.src = streams[index];
        audio.load();
        audio.play()
            .then(function() {
                isPlaying = true;
                autoplayBlocked = false;
                setAudioState('playing');
            })
            .catch(function(e) {
                isPlaying = false;
                if (e.name === 'NotAllowedError') {
                    // Browser blocked autoplay — will retry on first user interaction
                    autoplayBlocked = true;
                    audio.src = '';
                    setAudioState('idle');
                } else if (index + 1 < streams.length) {
                    tryPlay(index + 1);
                } else {
                    setAudioState('error');
                }
            });
    }

    audio.addEventListener('error', function() {
        if (streamIndex + 1 < streams.length) {
            tryPlay(streamIndex + 1);
        } else {
            isPlaying = false;
            setAudioState('error');
        }
    });

    audioBtn.addEventListener('click', function() {
        autoplayBlocked = false;
        if (!audio.src || audio.readyState === 0) {
            tryPlay(0);
        } else if (audio.paused) {
            audio.play()
                .then(function() { isPlaying = true; setAudioState('playing'); })
                .catch(function() { tryPlay(0); });
        } else if (audio.muted) {
            audio.muted = false;
            setAudioState('playing');
        } else {
            audio.muted = true;
            setAudioState('muted');
        }
    });

    // ── TRAFFIC LAYER ────────────────────────────────────────────
    var trafficEnabled   = false;
    var trafficMarkers   = [];
    var trafficHeatLayer = null;
    var trafficTimer     = null;
    var TRAFFIC_REFRESH_MS = 5 * 60 * 1000;

    // Waze alert type definitions
    var WAZE_TYPES = {
        'POLICE':       { cls: 'police',   emoji: '\uD83D\uDE94', label: 'Police' },
        'ACCIDENT':     { cls: 'accident', emoji: '\uD83D\uDCA5', label: 'Accident' },
        'HAZARD':       { cls: 'hazard',   emoji: '\u26A0\uFE0F', label: 'Hazard' },
        'ROAD_CLOSED':  { cls: 'closure',  emoji: '\uD83D\uDEA7', label: 'Road Closed' },
        'CONSTRUCTION': { cls: 'closure',  emoji: '\uD83D\uDEA7', label: 'Construction' },
    };

    function clearTrafficLayers() {
        trafficMarkers.forEach(function(m) { map.removeLayer(m); });
        trafficMarkers = [];
        if (trafficHeatLayer) { map.removeLayer(trafficHeatLayer); trafficHeatLayer = null; }
    }

    function setTrafficStatus(msg) {
        var el = document.getElementById('traffic-status');
        if (el) el.textContent = msg;
    }

    async function fetchTrafficData() {
        if (!trafficEnabled) return;
        setTrafficStatus('Scanning\u2026');

        // Ohio bounding box — enough to cover the whole state
        var wazeUrl = 'https://www.waze.com/live-map/api/georss' +
            '?env=na&types=alerts,traffic' +
            '&top=42.0&bottom=38.4&left=-84.8&right=-80.5';

        // Try two CORS proxies in sequence
        var proxies = [
            'https://corsproxy.io/?' + encodeURIComponent(wazeUrl),
            'https://api.allorigins.win/raw?url=' + encodeURIComponent(wazeUrl),
        ];

        var data = null;
        for (var pi = 0; pi < proxies.length; pi++) {
            try {
                var controller = new AbortController();
                var tid = setTimeout(function() { controller.abort(); }, 10000);
                var res = await fetch(proxies[pi], { signal: controller.signal });
                clearTimeout(tid);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                data = await res.json();
                break;
            } catch(e) { /* try next proxy */ }
        }

        if (!data) {
            setTrafficStatus('No signal — retrying');
            return;
        }

        clearTrafficLayers();

        // ── Incident markers ──────────────────────────────────
        var alerts  = data.alerts || [];
        var plotted = 0;
        alerts.forEach(function(alert) {
            var typeDef = WAZE_TYPES[alert.type] || WAZE_TYPES[alert.subtype];
            if (!typeDef) return;
            var lat = alert.location && alert.location.y;
            var lng = alert.location && alert.location.x;
            if (!lat || !lng) return;

            var colorMap = { police: '#3888c8', accident: '#e84040', hazard: '#e4a83c', closure: '#e87050' };
            var labelColor = colorMap[typeDef.cls] || '#b8d0f0';

            var popupHtml =
                '<strong style="color:' + labelColor + '">' + typeDef.label.toUpperCase() + '</strong>' +
                (alert.street ? '<br>\u{1F6E3} ' + alert.street : '') +
                (alert.city   ? ', ' + alert.city : '');

            var m = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: '',
                    html: '<div class="traffic-marker ' + typeDef.cls + '">' + typeDef.emoji + '</div>',
                    iconSize:   [24, 24],
                    iconAnchor: [12, 12],
                }),
                interactive: true,
                zIndexOffset: 300,
            });
            m.bindPopup(popupHtml, { closeButton: false, offset: [0, -8] });
            m.addTo(map);
            trafficMarkers.push(m);
            plotted++;
        });

        // ── Traffic jam heatmap ───────────────────────────────
        var jams = data.jams || [];
        if (jams.length > 0 && typeof L.heatLayer === 'function') {
            var heatPoints = [];
            jams.forEach(function(jam) {
                var intensity = Math.min(1.0, (jam.delay || 60) / 90);
                (jam.line || []).forEach(function(pt) {
                    heatPoints.push([pt.y, pt.x, intensity]);
                });
            });
            if (heatPoints.length > 0) {
                trafficHeatLayer = L.heatLayer(heatPoints, {
                    radius:  18,
                    blur:    12,
                    maxZoom: 15,
                    max:     1.0,
                    gradient: { 0.0: '#1166ff', 0.4: '#66aaff', 0.7: '#ff8800', 1.0: '#ff2200' },
                }).addTo(map);
            }
        }

        var jamCount = jams.length;
        setTrafficStatus(
            plotted === 0 && jamCount === 0
                ? 'Clear roads'
                : plotted + ' alert' + (plotted !== 1 ? 's' : '') +
                  ' \u00B7 ' + jamCount + ' jam' + (jamCount !== 1 ? 's' : '')
        );
    }

    // Traffic toggle controls
    document.querySelectorAll('#traffic-seg .seg-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#traffic-seg .seg-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            var legend = document.getElementById('traffic-legend');
            if (btn.dataset.traffic === 'on') {
                trafficEnabled = true;
                if (legend) legend.classList.add('visible');
                fetchTrafficData();
                clearInterval(trafficTimer);
                trafficTimer = setInterval(fetchTrafficData, TRAFFIC_REFRESH_MS);
            } else {
                trafficEnabled = false;
                if (legend) legend.classList.remove('visible');
                clearInterval(trafficTimer);
                clearTrafficLayers();
                setTrafficStatus('\u2014 Inactive \u2014');
            }
        });
    });

    // ── SPLASH DISMISS ───────────────────────────────────────────
    // The splash screen acts as the user-gesture gate required by browsers
    // before audio can autoplay. Dismissing it starts both audio and camera.
    var splash = document.getElementById('splash');
    function startExperience() {
        splash.classList.add('fade-out');
        splash.addEventListener('transitionend', function() {
            splash.style.display = 'none';
        }, { once: true });
        flyToShot(0);
        tryPlay(0);
    }
    splash.addEventListener('click', startExperience, { once: true });
    splash.addEventListener('touchend', startExperience, { once: true });

    </script>
</body>
</html>
