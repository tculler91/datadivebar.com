<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Barcade | Data Dive Bar</title>
    <meta name="description" content="Retro arcade games in the back of the Data Dive Bar. High scores are public, excuses are not.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bowlby+One&family=Special+Elite&family=IBM+Plex+Mono:wght@400;500;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-red: #ff3c28;
            --neon-blue: #00d4ff;
            --neon-amber: #ffb800;
            --neon-green: #39ff14;
            --neon-pink: #ff2d7b;
            --neon-purple: #b44aff;
            --dark-bg: #0a0a0e;
            --bar-wood: #1a1410;
            --smoke: #1c1c24;
            --glass: rgba(255, 255, 255, 0.04);
            --text-dim: #6b6b7b;
            --text-light: #c8c8d4;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; }

        body {
            background: var(--dark-bg);
            color: var(--text-light);
            font-family: 'IBM Plex Mono', monospace;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Dark brick wall texture */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                repeating-linear-gradient(
                    0deg, transparent, transparent 48px,
                    rgba(30, 25, 20, 0.7) 48px, rgba(30, 25, 20, 0.7) 50px
                ),
                repeating-linear-gradient(
                    90deg, transparent, transparent 96px,
                    rgba(30, 25, 20, 0.7) 96px, rgba(30, 25, 20, 0.7) 98px
                );
            background-size: 98px 50px;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }

        /* Noise/grime overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.06'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 1000;
        }

        .vignette {
            position: fixed;
            inset: 0;
            background: radial-gradient(
                ellipse at 50% 40%,
                transparent 20%,
                rgba(5, 5, 8, 0.55) 55%,
                rgba(2, 2, 4, 0.92) 100%
            );
            pointer-events: none;
            z-index: 1;
        }

        .smoke-layer {
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 50%, rgba(255, 184, 0, 0.015) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 30%, rgba(255, 45, 123, 0.01) 0%, transparent 50%),
                linear-gradient(180deg, rgba(28, 28, 36, 0.3) 0%, transparent 40%, rgba(28, 28, 36, 0.4) 100%);
            pointer-events: none;
            z-index: 1;
        }

        .ambient {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }
        .ambient-1 {
            width: 600px; height: 350px;
            background: radial-gradient(ellipse, rgba(180, 74, 255, 0.06) 0%, rgba(180, 74, 255, 0.015) 40%, transparent 70%);
            top: -5%; left: -8%;
            filter: blur(60px);
        }
        .ambient-2 {
            width: 500px; height: 300px;
            background: radial-gradient(ellipse, rgba(255, 45, 123, 0.05) 0%, rgba(255, 45, 123, 0.01) 40%, transparent 70%);
            bottom: 5%; right: -8%;
            filter: blur(60px);
        }
        .ambient-3 {
            width: 800px; height: 250px;
            background: radial-gradient(ellipse, rgba(0, 212, 255, 0.03) 0%, transparent 60%);
            top: 35%; left: 20%;
            filter: blur(80px);
        }

        .container {
            position: relative;
            z-index: 2;
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ---- NAV ---- */
        nav {
            padding: 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            width: 100%;
        }
        .nav-logo {
            font-family: 'Special Elite', cursive;
            font-size: 0.85rem;
            color: var(--neon-amber);
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 184, 0, 0.2);
            text-decoration: none;
        }
        .nav-logo:hover {
            text-shadow: 0 0 15px rgba(255, 184, 0, 0.4);
        }
        .nav-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        .status-dot {
            width: 6px; height: 6px;
            background: var(--neon-green);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--neon-green), 0 0 14px rgba(57,255,20,0.2);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ---- BARCADE HEADER ---- */
        .barcade-header {
            padding: 3rem 0 1.5rem;
            text-align: center;
            width: 100%;
        }
        .barcade-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(1.2rem, 3.5vw, 2rem);
            color: var(--neon-pink);
            text-shadow:
                0 0 8px rgba(255, 45, 123, 0.6),
                0 0 20px rgba(255, 45, 123, 0.3),
                0 0 40px rgba(255, 45, 123, 0.15);
            letter-spacing: 4px;
            margin-bottom: 0.75rem;
            animation: arcade-flicker 5s ease-in-out infinite;
        }
        @keyframes arcade-flicker {
            0%, 100% { opacity: 1; }
            94% { opacity: 1; }
            95% { opacity: 0.7; }
            96% { opacity: 1; }
            98% { opacity: 0.85; }
            99% { opacity: 1; }
        }
        .barcade-subtitle {
            font-family: 'Special Elite', cursive;
            font-size: 0.85rem;
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        /* ---- GAME CABINET ---- */
        .cabinet {
            width: 100%;
            max-width: 840px;
            margin: 2rem auto;
            position: relative;
        }

        /* Arcade cabinet frame */
        .cabinet-frame {
            background: linear-gradient(180deg, #1a1520 0%, #12101a 50%, #0d0b12 100%);
            border: 2px solid rgba(180, 74, 255, 0.2);
            border-radius: 8px 8px 4px 4px;
            padding: 20px 20px 16px;
            box-shadow:
                0 0 20px rgba(180, 74, 255, 0.08),
                0 0 60px rgba(180, 74, 255, 0.03),
                inset 0 1px 0 rgba(255,255,255,0.04),
                0 10px 40px rgba(0, 0, 0, 0.6);
            position: relative;
        }
        /* Cabinet header strip */
        .cabinet-frame::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg,
                transparent,
                var(--neon-pink) 20%,
                var(--neon-purple) 50%,
                var(--neon-blue) 80%,
                transparent
            );
            border-radius: 8px 8px 0 0;
            opacity: 0.6;
        }

        /* HUD above canvas */
        .game-hud {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 4px 8px;
            font-family: 'Press Start 2P', monospace;
            font-size: 11px;
        }
        .hud-score { color: var(--neon-green); text-shadow: 0 0 8px rgba(57, 255, 20, 0.6); }
        .hud-wave { color: var(--neon-amber); text-shadow: 0 0 8px rgba(255, 184, 0, 0.6); }
        .hud-lives { color: var(--neon-pink); text-shadow: 0 0 8px rgba(255, 45, 123, 0.6); }
        .hud-hi { color: var(--neon-blue); text-shadow: 0 0 8px rgba(0, 212, 255, 0.5); font-size: 9px; }

        /* Game canvas */
        #game {
            width: 100%;
            display: block;
            border: 1px solid rgba(255, 45, 123, 0.3);
            box-shadow:
                0 0 10px rgba(255, 45, 123, 0.2),
                0 0 30px rgba(255, 45, 123, 0.06),
                inset 0 0 20px rgba(0, 0, 0, 0.4);
            border-radius: 2px;
            image-rendering: pixelated;
        }

        /* Cabinet coin slot */
        .cabinet-coin {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 10px 0 0;
            font-family: 'Press Start 2P', monospace;
            font-size: 7px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }
        .coin-slot {
            width: 28px; height: 4px;
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 2px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }

        /* ---- GAME OVERLAY ---- */
        #overlay {
            position: absolute;
            top: 20px; /* account for cabinet padding */
            left: 20px;
            right: 20px;
            bottom: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(10, 8, 12, 0.88);
            z-index: 10;
            backdrop-filter: blur(3px);
            border-radius: 2px;
            transition: opacity 0.3s;
        }
        #overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .game-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(18px, 4vw, 32px);
            color: var(--neon-pink);
            text-shadow: 0 0 15px rgba(255, 45, 123, 0.7), 0 0 30px rgba(255, 45, 123, 0.3);
            letter-spacing: 3px;
            text-align: center;
        }
        .game-subtitle {
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: var(--neon-blue);
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.4);
            margin-top: 10px;
            letter-spacing: 2px;
        }
        .game-tagline {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            color: #c9a96e;
            margin-top: 16px;
            text-align: center;
            max-width: 380px;
            line-height: 1.6;
        }
        .start-btn {
            margin-top: 24px;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            padding: 12px 28px;
            background: transparent;
            color: var(--neon-green);
            border: 2px solid var(--neon-green);
            cursor: pointer;
            text-shadow: 0 0 8px rgba(57, 255, 20, 0.6);
            box-shadow: 0 0 12px rgba(57, 255, 20, 0.25), inset 0 0 12px rgba(57, 255, 20, 0.08);
            transition: all 0.2s;
            border-radius: 2px;
        }
        .start-btn:hover {
            background: rgba(57, 255, 20, 0.1);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.4), inset 0 0 20px rgba(57, 255, 20, 0.12);
            transform: scale(1.04);
        }
        .controls-info {
            margin-top: 20px;
            font-family: 'Press Start 2P', monospace;
            font-size: 7px;
            color: #6a5a4a;
            text-align: center;
            line-height: 2.2;
        }
        .controls-info span {
            color: var(--neon-amber);
            text-shadow: 0 0 4px rgba(255, 184, 0, 0.3);
        }

        /* Game Over panel */
        #game-over-panel {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .go-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(16px, 3.5vw, 28px);
            color: var(--neon-pink);
            text-shadow: 0 0 15px rgba(255, 45, 123, 0.7);
        }
        .final-score {
            font-family: 'Press Start 2P', monospace;
            font-size: 13px;
            color: var(--neon-green);
            text-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
        }
        .wave-reached {
            font-family: 'Press Start 2P', monospace;
            font-size: 9px;
            color: var(--neon-amber);
            text-shadow: 0 0 6px rgba(255, 184, 0, 0.4);
        }
        .name-entry {
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .name-entry label {
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: var(--neon-amber);
            text-shadow: 0 0 5px rgba(255, 184, 0, 0.3);
        }
        .name-entry input {
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            width: 170px;
            text-align: center;
            padding: 7px;
            background: rgba(0,0,0,0.6);
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            text-shadow: 0 0 5px rgba(0, 212, 255, 0.4);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.15);
            border-radius: 2px;
            outline: none;
            text-transform: uppercase;
            letter-spacing: 4px;
        }
        .name-entry input::placeholder {
            color: rgba(0, 212, 255, 0.25);
            letter-spacing: 2px;
        }

        /* Leaderboard */
        #leaderboard-panel {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            max-height: 80%;
            width: 90%;
            max-width: 460px;
        }
        .lb-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 18px;
            color: var(--neon-amber);
            text-shadow: 0 0 12px rgba(255, 184, 0, 0.5);
            margin-bottom: 4px;
        }
        .lb-table {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-pink) transparent;
        }
        .lb-table::-webkit-scrollbar { width: 3px; }
        .lb-table::-webkit-scrollbar-thumb { background: var(--neon-pink); border-radius: 2px; }

        .lb-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 10px;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            border-bottom: 1px solid rgba(200, 170, 100, 0.08);
            transition: background 0.2s;
        }
        .lb-row:hover { background: rgba(255, 234, 0, 0.04); }
        .lb-row.highlight { background: rgba(57, 255, 20, 0.08); }
        .lb-rank { color: #6a5a4a; width: 32px; }
        .lb-row:nth-child(1) .lb-rank { color: var(--neon-amber); text-shadow: 0 0 5px rgba(255, 184, 0, 0.4); }
        .lb-row:nth-child(2) .lb-rank { color: #c0c0c0; text-shadow: 0 0 3px rgba(192,192,192,0.3); }
        .lb-row:nth-child(3) .lb-rank { color: #cd7f32; text-shadow: 0 0 3px rgba(205,127,50,0.3); }
        .lb-name { color: var(--neon-blue); flex: 1; margin: 0 10px; text-shadow: 0 0 3px rgba(0,212,255,0.2); }
        .lb-score { color: var(--neon-green); text-shadow: 0 0 3px rgba(57,255,20,0.2); }
        .lb-wave { color: var(--neon-amber); width: 50px; text-align: right; text-shadow: 0 0 3px rgba(255,184,0,0.2); }

        .small-btn {
            font-size: 8px !important;
            padding: 7px 18px !important;
            color: var(--neon-amber) !important;
            border-color: var(--neon-amber) !important;
            box-shadow: 0 0 8px rgba(255, 184, 0, 0.15) !important;
            text-shadow: 0 0 5px rgba(255, 184, 0, 0.3) !important;
        }
        .dim-btn {
            font-size: 7px !important;
            padding: 5px 14px !important;
            margin-top: 2px !important;
            color: #6a5a4a !important;
            border-color: #6a5a4a !important;
            box-shadow: none !important;
            text-shadow: none !important;
        }

        /* ---- LEADERBOARD SECTION (below game) ---- */
        .leaderboard-section {
            width: 100%;
            max-width: 840px;
            margin: 2.5rem auto 1rem;
        }
        .lb-section-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            color: var(--text-dim);
            font-size: 0.65rem;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        .lb-section-header::before,
        .lb-section-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
        }

        .lb-board {
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 4px;
            padding: 1.5rem;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.03), 0 4px 20px rgba(0,0,0,0.3);
        }
        .lb-board-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            color: var(--neon-amber);
            text-shadow: 0 0 10px rgba(255, 184, 0, 0.4);
            text-align: center;
            margin-bottom: 1rem;
        }
        .lb-board-header {
            display: flex;
            justify-content: space-between;
            padding: 0 10px 8px;
            font-family: 'Press Start 2P', monospace;
            font-size: 6px;
            color: #4a4a5a;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .lb-board-header span:first-child { width: 32px; }
        .lb-board-header span:nth-child(2) { flex: 1; margin: 0 10px; }
        .lb-board-header span:nth-child(3) { width: 80px; text-align: right; }
        .lb-board-header span:last-child { width: 50px; text-align: right; }

        #live-leaderboard { min-height: 60px; }
        #live-leaderboard .lb-row {
            font-size: 9px;
            padding: 6px 10px;
        }
        .lb-empty {
            text-align: center;
            padding: 24px;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: #4a4a5a;
            line-height: 2;
        }
        .lb-loading {
            text-align: center;
            padding: 24px;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: var(--neon-blue);
            text-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* ---- MOBILE CONTROLS ---- */
        #mobile-controls {
            display: none;
            position: fixed;
            bottom: 10px;
            left: 0; right: 0;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 20;
        }
        #mobile-controls button {
            font-family: 'Press Start 2P', monospace;
            font-size: 18px;
            padding: 14px 20px;
            background: rgba(10, 10, 14, 0.85);
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            border-radius: 6px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        #mobile-controls button:active { background: rgba(0, 212, 255, 0.12); }
        #fire-btn { border-color: var(--neon-pink) !important; color: var(--neon-pink) !important; }

        @media (pointer: coarse) {
            #mobile-controls { display: flex; }
            .cabinet { margin-bottom: 80px; }
        }

        /* ---- FOOTER ---- */
        footer {
            border-top: 1px solid rgba(255,255,255,0.06);
            padding: 2rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            position: relative;
            text-align: center;
            width: 100%;
            margin-top: 3rem;
        }
        footer::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 184, 0, 0.15), transparent);
        }
        .footer-left {
            font-size: 0.7rem;
            color: var(--text-dim);
            letter-spacing: 1px;
        }
        .footer-right {
            font-family: 'Special Elite', cursive;
            font-size: 0.7rem;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        @media (max-width: 600px) {
            .barcade-title { letter-spacing: 2px; }
            .cabinet-frame { padding: 12px 12px 10px; }
            .game-hud { font-size: 8px; }
            .game-title { letter-spacing: 1px; }
            .lb-board { padding: 1rem; }
            #live-leaderboard .lb-row { font-size: 7px; padding: 4px 6px; }
        }
    </style>
</head>
<body>

<div class="vignette"></div>
<div class="smoke-layer"></div>
<div class="ambient ambient-1"></div>
<div class="ambient ambient-2"></div>
<div class="ambient ambient-3"></div>

<div class="container">

    <nav>
        <a href="/" class="nav-logo">Data Dive Bar</a>
        <div class="nav-status">
            <div class="status-dot"></div>
            <span>Barcade Open</span>
        </div>
    </nav>

    <div class="barcade-header">
        <div class="barcade-title">THE BARCADE</div>
        <div class="barcade-subtitle">Quarter up or step aside</div>
    </div>

    <!-- ====== ARCADE CABINET ====== -->
    <div class="cabinet">
        <div class="cabinet-frame">
            <div class="game-hud">
                <div>
                    <div class="hud-score">SCORE <span id="score-val">0</span></div>
                    <div class="hud-hi">HI <span id="hi-score-val">0</span></div>
                </div>
                <div class="hud-wave">WAVE <span id="wave-val">1</span></div>
                <div class="hud-lives" id="lives-display">‚ô• ‚ô• ‚ô•</div>
            </div>

            <canvas id="game"></canvas>

            <div id="overlay">
                <div id="title-panel">
                    <div class="game-title">BAR INVADERS</div>
                    <div class="game-subtitle">~ DEFEND YOUR DIVE ~</div>
                    <div class="game-tagline">The pretentious cocktails are invading YOUR dive bar.<br>Defend it with bottle caps and bad attitude.</div>
                    <button class="start-btn" id="start-btn">INSERT COIN</button>
                    <div class="controls-info">
                        <span>‚Üê ‚Üí</span> or <span>A D</span> MOVE &nbsp;&nbsp; <span>SPACE</span> FIRE<br>
                        <span>P</span> PAUSE &nbsp;&nbsp; <span>M</span> MUTE
                    </div>
                </div>
                <div id="game-over-panel">
                    <div class="go-title">GAME OVER</div>
                    <div class="final-score">SCORE: <span id="final-score-val">0</span></div>
                    <div class="wave-reached">WAVE: <span id="final-wave-val">1</span></div>
                    <div class="name-entry">
                        <label>ENTER YOUR NAME</label>
                        <input type="text" id="player-name" maxlength="8" placeholder="--------" autocomplete="off" spellcheck="false">
                    </div>
                    <button class="start-btn" id="submit-score-btn">SUBMIT & PLAY AGAIN</button>
                    <button class="start-btn small-btn" id="view-lb-btn">VIEW LEADERBOARD</button>
                </div>
                <div id="leaderboard-panel">
                    <div class="lb-title">TOP 20</div>
                    <div class="lb-table" id="lb-table"></div>
                    <button class="start-btn" id="lb-play-btn" style="margin-top:8px;">PLAY AGAIN</button>
                    <button class="start-btn dim-btn" id="lb-back-btn">BACK</button>
                </div>
            </div>

            <div class="cabinet-coin">
                <div class="coin-slot"></div>
                <span>INSERT COIN</span>
                <div class="coin-slot"></div>
            </div>
        </div>
    </div>

    <!-- ====== LIVE LEADERBOARD (always visible) ====== -->
    <div class="leaderboard-section">
        <div class="lb-section-header">high scores</div>
        <div class="lb-board">
            <div class="lb-board-title">üèÜ TOP 20</div>
            <div class="lb-board-header">
                <span>#</span>
                <span>Name</span>
                <span>Score</span>
                <span>Wave</span>
            </div>
            <div id="live-leaderboard">
                <div class="lb-loading">LOADING...</div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-left">&copy; 2025 Data Dive Bar &mdash; No cover. No dress code. No apologies.</div>
        <span style="color: var(--text-dim); opacity: 0.3;">|</span>
        <div class="footer-right">est. 2025</div>
    </footer>

</div>

<div id="mobile-controls">
    <div>
        <button id="left-btn">‚óÄ</button>
        <button id="right-btn">‚ñ∂</button>
    </div>
    <button id="fire-btn">FIRE</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

<script>
// ============================================================
// FIREBASE CONFIG - Replace with your own Firebase project config
// ============================================================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

let db = null;
let firebaseReady = false;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  firebaseReady = !firebaseConfig.apiKey.startsWith("YOUR_");
} catch(e) {
  console.warn("Firebase not configured ‚Äî using local fallback.");
}

// ============================================================
// AUDIO ENGINE
// ============================================================
class AudioEngine {
  constructor() { this.ctx = null; this.muted = false; this.masterGain = null; this.initialized = false; }
  init() {
    if (this.initialized) return;
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      this.masterGain = this.ctx.createGain();
      this.masterGain.gain.value = 0.3;
      this.masterGain.connect(this.ctx.destination);
      this.initialized = true;
    } catch(e) {}
  }
  play(type) {
    if (!this.initialized || this.muted) return;
    const t = this.ctx.currentTime;
    switch(type) {
      case 'shoot': this._tone(880, 0.06, 'square', t, 0.8, 440); break;
      case 'hit': this._noise(0.1, t, 1200, 100); break;
      case 'explode': this._noise(0.25, t, 800, 50); this._tone(120, 0.2, 'sawtooth', t, 0.4, 40); break;
      case 'powerup': this._arp([523, 659, 784, 1047], 0.08, 'square', t, 0.5); break;
      case 'playerhit': this._noise(0.4, t, 2000, 80); this._tone(200, 0.4, 'sawtooth', t, 0.6, 50); break;
      case 'wave': this._arp([392, 494, 587, 784, 587, 784, 1047], 0.1, 'square', t, 0.4); break;
      case 'gameover': this._arp([523, 494, 440, 392, 349, 330, 262], 0.18, 'sawtooth', t, 0.5); break;
      case 'bonus': this._arp([660, 880, 1100], 0.06, 'square', t, 0.3); break;
    }
  }
  _tone(freq, dur, type, time, vol = 0.5, endFreq = null) {
    const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, time);
    if (endFreq) osc.frequency.linearRampToValueAtTime(endFreq, time + dur);
    g.gain.setValueAtTime(vol, time); g.gain.exponentialRampToValueAtTime(0.001, time + dur);
    osc.connect(g); g.connect(this.masterGain); osc.start(time); osc.stop(time + dur + 0.01);
  }
  _noise(dur, time, hiFreq = 2000, loFreq = 100) {
    const bufSize = this.ctx.sampleRate * dur;
    const buf = this.ctx.createBuffer(1, bufSize, this.ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
    const src = this.ctx.createBufferSource(); src.buffer = buf;
    const filt = this.ctx.createBiquadFilter(); filt.type = 'bandpass';
    filt.frequency.setValueAtTime(hiFreq, time); filt.frequency.linearRampToValueAtTime(loFreq, time + dur); filt.Q.value = 1;
    const g = this.ctx.createGain(); g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time + dur);
    src.connect(filt); filt.connect(g); g.connect(this.masterGain); src.start(time); src.stop(time + dur + 0.01);
  }
  _arp(freqs, noteDur, type, time, vol = 0.4) {
    freqs.forEach((f, i) => this._tone(f, noteDur * 1.2, type, time + i * noteDur, vol));
  }
  toggle() {
    this.muted = !this.muted;
    if (this.masterGain) this.masterGain.gain.value = this.muted ? 0 : 0.3;
    return this.muted;
  }
}
const audio = new AudioEngine();

// ============================================================
// GAME ENGINE
// ============================================================
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = 640, H = 480;
canvas.width = W; canvas.height = H;

let state = 'menu';
let score = 0, hiScore = parseInt(localStorage.getItem('barInvadersHi') || '0'), wave = 1, lives = 3;
let lastPlayerName = localStorage.getItem('barInvadersName') || '';
let frameCount = 0, shakeAmount = 0, shakeDecay = 0.9;
let comboCount = 0, comboTimer = 0, waveTransition = 0, waveTransitionText = '';

const scoreEl = document.getElementById('score-val');
const hiScoreEl = document.getElementById('hi-score-val');
const waveEl = document.getElementById('wave-val');
const livesEl = document.getElementById('lives-display');
hiScoreEl.textContent = hiScore;

function updateHUD() {
  scoreEl.textContent = score; waveEl.textContent = wave;
  if (score > hiScore) { hiScore = score; hiScoreEl.textContent = hiScore; localStorage.setItem('barInvadersHi', hiScore); }
  let h = ''; for (let i = 0; i < lives; i++) h += '‚ô• '; livesEl.textContent = h.trim();
}

// Player
const player = { x: W/2, y: H-40, w: 32, h: 24, speed: 5, fireRate: 12, fireTimer: 0, multiShot: false, shieldHP: 0, rapidFire: false, rapidTimer: 0, multiTimer: 0, invincible: 0, visible: true };

// Sprite drawing
function drawPlayer(x, y) {
  const cx = Math.floor(x), cy = Math.floor(y);
  ctx.fillStyle = '#d4a030'; ctx.fillRect(cx-12, cy-8, 24, 20);
  ctx.fillStyle = '#fff8dc'; ctx.fillRect(cx-12, cy-12, 24, 6); ctx.fillRect(cx-14, cy-10, 2, 4); ctx.fillRect(cx+12, cy-10, 2, 4);
  ctx.fillStyle = '#c8820a'; ctx.fillRect(cx-10, cy-4, 20, 14);
  ctx.fillStyle = '#d4a030'; ctx.fillRect(cx+12, cy-4, 4, 2); ctx.fillRect(cx+14, cy-4, 2, 12); ctx.fillRect(cx+12, cy+6, 4, 2);
  ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fillRect(cx-8, cy-2, 3, 10);
  if (player.shieldHP > 0) {
    ctx.strokeStyle = `rgba(0,212,255,${0.4+Math.sin(frameCount*0.1)*0.3})`; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(cx, cy, 20, 0, Math.PI*2); ctx.stroke();
  }
}

const ENEMY_TYPES = {
  martini: { w:24, h:24, points:10, color:'#c9f0ff', accent:'#7aecff', hp:1 },
  wine: { w:20, h:28, points:20, color:'#8b0033', accent:'#ff2d7b', hp:1 },
  cocktail: { w:26, h:22, points:30, color:'#ff6a00', accent:'#ffea00', hp:2 },
  champagne: { w:22, h:30, points:50, color:'#ffe066', accent:'#ffd700', hp:2 },
  absinthe: { w:24, h:26, points:75, color:'#39ff14', accent:'#00ff88', hp:3 }
};

function drawEnemy(type, x, y, frame) {
  const cx = Math.floor(x), cy = Math.floor(y), bob = Math.sin(frame*0.08)*2, ey = cy+bob;
  ctx.save();
  switch(type) {
    case 'martini':
      ctx.fillStyle = '#c9f0ff'; ctx.beginPath(); ctx.moveTo(cx, ey-12); ctx.lineTo(cx-12, ey+2); ctx.lineTo(cx+12, ey+2); ctx.fill();
      ctx.fillRect(cx-1, ey+2, 3, 8); ctx.fillRect(cx-6, ey+10, 13, 2);
      ctx.fillStyle = '#39ff14'; ctx.fillRect(cx+4, ey-6, 5, 5);
      ctx.fillStyle = '#ff2d7b'; ctx.fillRect(cx+5, ey-5, 3, 3); break;
    case 'wine':
      ctx.fillStyle = '#8b0033'; ctx.beginPath(); ctx.arc(cx, ey-4, 10, 0, Math.PI); ctx.fill();
      ctx.fillRect(cx-10, ey-8, 20, 5); ctx.fillStyle = '#ff2d7b'; ctx.fillRect(cx-8, ey-8, 16, 3);
      ctx.fillStyle = '#d4d4d4'; ctx.fillRect(cx-1, ey+4, 3, 8); ctx.fillRect(cx-5, ey+12, 11, 2); break;
    case 'cocktail':
      ctx.fillStyle = '#a0522d'; ctx.fillRect(cx-10, ey-8, 20, 18);
      ctx.fillStyle = '#000'; ctx.fillRect(cx-6, ey-4, 3, 3); ctx.fillRect(cx+3, ey-4, 3, 3); ctx.fillRect(cx-4, ey+3, 8, 2);
      ctx.fillStyle = '#ffea00'; ctx.beginPath(); ctx.moveTo(cx+4, ey-14); ctx.lineTo(cx-4, ey-8); ctx.lineTo(cx+12, ey-8); ctx.fill();
      ctx.fillStyle = '#8b4513'; ctx.fillRect(cx+4, ey-14, 1, 10); break;
    case 'champagne':
      ctx.fillStyle = '#ffe066'; ctx.fillRect(cx-5, ey-14, 10, 16);
      ctx.fillStyle = '#fff'; const bt = frame*0.15;
      ctx.fillRect(cx-2, ey-10+Math.sin(bt)*3, 2, 2); ctx.fillRect(cx+1, ey-6+Math.sin(bt+1)*3, 2, 2); ctx.fillRect(cx-1, ey-2+Math.sin(bt+2)*2, 2, 2);
      ctx.fillStyle = '#d4d4d4'; ctx.fillRect(cx-1, ey+2, 2, 8); ctx.fillRect(cx-4, ey+10, 8, 2);
      ctx.fillStyle = '#ffd700'; ctx.fillRect(cx-6, ey-14, 12, 2); break;
    case 'absinthe':
      ctx.fillStyle = '#1a4d1a'; ctx.fillRect(cx-8, ey-6, 16, 18); ctx.fillRect(cx-4, ey-14, 8, 10);
      ctx.fillStyle = '#39ff14'; ctx.fillRect(cx-6, ey, 12, 8);
      ctx.fillStyle = `rgba(57,255,20,${0.2+Math.sin(frame*0.12)*0.15})`; ctx.fillRect(cx-10, ey-8, 20, 22);
      ctx.fillStyle = '#00ff88'; ctx.fillRect(cx-4, ey-12, 3, 3); ctx.fillRect(cx+1, ey-12, 3, 3); break;
  }
  ctx.restore();
}

// Game objects
let enemies = [], bullets = [], enemyBullets = [], particles = [], powerups = [], stars = [];
for (let i = 0; i < 60; i++) stars.push({ x: Math.random()*W, y: Math.random()*H, size: Math.random()*1.5+0.5, speed: Math.random()*0.3+0.1, brightness: Math.random()*0.5+0.2 });

let enemyDir = 1, enemySpeed = 0.5, enemyDropSpeed = 0, enemyFireRate = 50, enemyFireTimer = 0;

function spawnWave(waveNum) {
  enemies = [];
  const types = Object.keys(ENEMY_TYPES);
  const rows = Math.min(3+Math.floor(waveNum/3), 6);
  const cols = Math.min(6+Math.floor(waveNum/2), 11);
  const spacing = 48, startX = (W-(cols-1)*spacing)/2, startY = 50;
  for (let r = 0; r < rows; r++) {
    let ti; if (waveNum<=2) ti=Math.min(r,1); else if (waveNum<=5) ti=Math.min(r,2); else if (waveNum<=8) ti=Math.min(r,3); else ti=Math.min(r,4);
    const type = types[ti], base = ENEMY_TYPES[type];
    for (let c = 0; c < cols; c++) {
      enemies.push({ type, x: startX+c*spacing, y: startY+r*38, w: base.w, h: base.h, hp: base.hp+Math.floor(waveNum/6), maxHp: base.hp+Math.floor(waveNum/6), points: base.points+waveNum*2, alive: true, frame: Math.random()*100 });
    }
  }
  enemyDir = 1; enemySpeed = 0.4+waveNum*0.08; enemyDropSpeed = 0;
  enemyFireRate = Math.max(15, 60-waveNum*3); enemyFireTimer = 0;
}

function spawnParticles(x, y, color, count = 8, speed = 3) {
  for (let i = 0; i < count; i++) {
    const angle = (Math.PI*2/count)*i+Math.random()*0.5, vel = speed*(0.5+Math.random()*0.8);
    particles.push({ x, y, vx: Math.cos(angle)*vel, vy: Math.sin(angle)*vel, life: 1, decay: 0.02+Math.random()*0.02, size: 2+Math.random()*3, color });
  }
}
function spawnExplosion(x, y, type) {
  const colors = { martini:['#c9f0ff','#7aecff','#fff'], wine:['#8b0033','#ff2d7b','#ff6699'], cocktail:['#ff6a00','#ffea00','#ffa500'], champagne:['#ffe066','#ffd700','#fff8dc'], absinthe:['#39ff14','#00ff88','#88ff88'] };
  (colors[type]||['#fff','#ff0','#f80']).forEach(col => spawnParticles(x, y, col, 6, 3.5));
  shakeAmount = 4;
}

const POWERUP_TYPES = [
  { type:'rapid', color:'#ff2d7b', label:'‚ö°', desc:'RAPID FIRE' },
  { type:'multi', color:'#00d4ff', label:'‚ú¶', desc:'MULTI SHOT' },
  { type:'shield', color:'#39ff14', label:'‚ô¶', desc:'SHIELD' },
  { type:'bomb', color:'#ffea00', label:'‚ú∏', desc:'BAR BOMB' },
  { type:'life', color:'#ff6a00', label:'‚ô•', desc:'EXTRA LIFE' }
];
function maybeDropPowerup(x, y) {
  if (Math.random() < 0.08) {
    const p = POWERUP_TYPES[Math.floor(Math.random()*POWERUP_TYPES.length)];
    if (p.type === 'life' && Math.random() > 0.3) return;
    powerups.push({ ...p, x, y, vy: 1.2, w: 16, h: 16, frame: 0 });
  }
}
function activatePowerup(p) {
  audio.play('powerup'); showFloatingText(p.x, p.y, p.desc, p.color);
  switch(p.type) {
    case 'rapid': player.rapidFire = true; player.rapidTimer = 360; break;
    case 'multi': player.multiShot = true; player.multiTimer = 360; break;
    case 'shield': player.shieldHP = 3; break;
    case 'bomb':
      enemies.forEach(e => { if (e.alive) { e.hp -= 2; if (e.hp <= 0) { e.alive = false; score += e.points; spawnExplosion(e.x, e.y, e.type); } } });
      shakeAmount = 12; spawnParticles(W/2, H/2, '#ffea00', 30, 8); spawnParticles(W/2, H/2, '#fff', 20, 6); audio.play('explode'); break;
    case 'life': if (lives < 5) lives++; break;
  }
}

let floatingTexts = [];
function showFloatingText(x, y, text, color = '#fff', size = 10) { floatingTexts.push({ x, y, text, color, size, life: 1, vy: -1 }); }

// Input
const keys = {};
document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (e.code === 'KeyP' && state === 'playing') state = 'paused';
  else if (e.code === 'KeyP' && state === 'paused') state = 'playing';
  if (e.code === 'KeyM') { const m = audio.toggle(); showFloatingText(W/2, H/2, m ? 'MUTED' : 'UNMUTED', '#fff', 14); }
  if (['Space','ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.code)) e.preventDefault();
});
document.addEventListener('keyup', e => { keys[e.code] = false; });

const mobileState = { left: false, right: false, fire: false };
function setupMobileBtn(id, key) {
  const btn = document.getElementById(id); if (!btn) return;
  btn.addEventListener('touchstart', e => { e.preventDefault(); mobileState[key] = true; });
  btn.addEventListener('touchend', e => { e.preventDefault(); mobileState[key] = false; });
  btn.addEventListener('touchcancel', e => { mobileState[key] = false; });
}
setupMobileBtn('left-btn','left'); setupMobileBtn('right-btn','right'); setupMobileBtn('fire-btn','fire');

function boxCollide(a, b) { return a.x-a.w/2 < b.x+b.w/2 && a.x+a.w/2 > b.x-b.w/2 && a.y-a.h/2 < b.y+b.h/2 && a.y+a.h/2 > b.y-b.h/2; }

function resetGame() {
  score = 0; wave = 1; lives = 3; player.x = W/2;
  player.rapidFire = false; player.multiShot = false; player.shieldHP = 0; player.invincible = 0;
  bullets = []; enemyBullets = []; particles = []; powerups = []; floatingTexts = []; comboCount = 0; comboTimer = 0;
  spawnWave(1); updateHUD();
}

function update() {
  if (state !== 'playing') return;
  frameCount++;
  let moveDir = 0;
  if (keys['ArrowLeft']||keys['KeyA']||mobileState.left) moveDir = -1;
  if (keys['ArrowRight']||keys['KeyD']||mobileState.right) moveDir = 1;
  player.x += moveDir * player.speed;
  player.x = Math.max(20, Math.min(W-20, player.x));
  if (player.invincible > 0) { player.invincible--; player.visible = Math.floor(player.invincible/4)%2===0; } else player.visible = true;
  if (player.rapidFire) { player.rapidTimer--; if (player.rapidTimer<=0) player.rapidFire=false; }
  if (player.multiShot) { player.multiTimer--; if (player.multiTimer<=0) player.multiShot=false; }

  player.fireTimer--;
  const fireRate = player.rapidFire ? 5 : player.fireRate;
  if ((keys['Space']||mobileState.fire) && player.fireTimer<=0) {
    audio.play('shoot'); player.fireTimer = fireRate;
    bullets.push({ x: player.x, y: player.y-14, w:4, h:8, vy:-8 });
    if (player.multiShot) {
      bullets.push({ x: player.x-10, y: player.y-10, w:4, h:8, vy:-7.5, vx:-1.5 });
      bullets.push({ x: player.x+10, y: player.y-10, w:4, h:8, vy:-7.5, vx:1.5 });
    }
  }

  if (comboTimer > 0) { comboTimer--; if (comboTimer<=0) comboCount=0; }

  bullets.forEach(b => { b.y += b.vy; if (b.vx) b.x += b.vx; });
  bullets = bullets.filter(b => b.y > -10 && b.x > -10 && b.x < W+10);
  enemyBullets.forEach(b => { b.x += b.vx; b.y += b.vy; });
  enemyBullets = enemyBullets.filter(b => b.y < H+10 && b.x > -10 && b.x < W+10);

  let hitEdge = false;
  const alive = enemies.filter(e => e.alive);
  alive.forEach(e => { e.x += enemyDir*enemySpeed; e.frame++; if (e.x<20||e.x>W-20) hitEdge=true; });
  if (enemyDropSpeed > 0) { alive.forEach(e => e.y += enemyDropSpeed); enemyDropSpeed -= 0.5; if (enemyDropSpeed<=0) enemyDropSpeed=0; }
  if (hitEdge) { enemyDir *= -1; enemyDropSpeed = 4; }

  enemyFireTimer++;
  if (enemyFireTimer >= enemyFireRate && alive.length > 0) {
    enemyFireTimer = 0;
    const cols = new Map(); alive.forEach(e => { const col = Math.round(e.x/48); if (!cols.has(col)||e.y>cols.get(col).y) cols.set(col,e); });
    const shooters = []; cols.forEach(e => shooters.push(e));
    if (shooters.length > 0) {
      const s = shooters[Math.floor(Math.random()*shooters.length)];
      const dx = player.x-s.x, dy = player.y-s.y, dist = Math.sqrt(dx*dx+dy*dy), spd = 2.5+wave*0.15;
      enemyBullets.push({ x:s.x, y:s.y+10, vx:(dx/dist)*spd*(0.8+Math.random()*0.4), vy:(dy/dist)*spd, w:6, h:6 });
    }
  }

  bullets.forEach(b => {
    alive.forEach(e => {
      if (boxCollide(b, e)) {
        b.y = -100; e.hp--;
        if (e.hp <= 0) {
          e.alive = false; comboCount++; comboTimer = 90;
          const mult = Math.min(comboCount, 8), pts = e.points*mult;
          score += pts;
          if (mult > 1) showFloatingText(e.x, e.y-10, `x${mult}`, '#ffea00', 12);
          showFloatingText(e.x, e.y, `+${pts}`, ENEMY_TYPES[e.type].accent, 9);
          spawnExplosion(e.x, e.y, e.type); maybeDropPowerup(e.x, e.y); audio.play('hit'); updateHUD();
        } else { spawnParticles(b.x, b.y, '#fff', 3, 2); audio.play('bonus'); }
      }
    });
  });

  if (player.invincible <= 0) {
    enemyBullets.forEach(b => {
      if (boxCollide(b, { x:player.x, y:player.y, w:player.w, h:player.h })) {
        b.y = H+100;
        if (player.shieldHP > 0) { player.shieldHP--; spawnParticles(player.x, player.y, '#00d4ff', 8, 2); audio.play('bonus'); }
        else playerHit();
      }
    });
  }
  alive.forEach(e => { if (e.y+e.h/2 > player.y-20 && player.invincible<=0) { if (player.shieldHP>0) player.shieldHP=0; else playerHit(); } });

  powerups.forEach(p => { p.y += p.vy; p.frame++;
    if (boxCollide(p, { x:player.x, y:player.y, w:player.w+8, h:player.h+8 })) { activatePowerup(p); p.y = H+100; }
  });
  powerups = powerups.filter(p => p.y < H+20);

  particles.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.life-=p.decay; });
  particles = particles.filter(p => p.life > 0);
  floatingTexts.forEach(t => { t.y+=t.vy; t.life-=0.015; });
  floatingTexts = floatingTexts.filter(t => t.life > 0);
  shakeAmount *= shakeDecay; if (shakeAmount<0.1) shakeAmount=0;

  if (alive.length===0 && waveTransition<=0) {
    wave++; waveTransition=120; waveTransitionText=`WAVE ${wave}`; audio.play('wave'); updateHUD();
    const wb = wave*100; score+=wb; showFloatingText(W/2, H/2+30, `WAVE BONUS +${wb}`, '#ffea00', 12); updateHUD();
  }
  if (waveTransition > 0) { waveTransition--; if (waveTransition===60) spawnWave(wave); }
}

function playerHit() {
  audio.play('playerhit'); lives--; player.invincible=120;
  spawnParticles(player.x, player.y, '#ff2d7b', 15, 4); spawnParticles(player.x, player.y, '#ffea00', 10, 3);
  shakeAmount=8; updateHUD(); if (lives<=0) gameOver();
}

function gameOver() {
  state = 'gameover'; audio.play('gameover');
  document.getElementById('final-score-val').textContent = score;
  document.getElementById('final-wave-val').textContent = wave;
  document.getElementById('title-panel').style.display = 'none';
  document.getElementById('game-over-panel').style.display = 'flex';
  document.getElementById('leaderboard-panel').style.display = 'none';
  document.getElementById('overlay').classList.remove('hidden');
  const ni = document.getElementById('player-name'); ni.value = lastPlayerName;
  setTimeout(() => ni.focus(), 100);
}

function draw() {
  ctx.save();
  if (shakeAmount > 0) ctx.translate((Math.random()-0.5)*shakeAmount*2, (Math.random()-0.5)*shakeAmount*2);

  ctx.fillStyle = '#060404'; ctx.fillRect(0, 0, W, H);
  stars.forEach(s => { s.y+=s.speed; if (s.y>H){s.y=0;s.x=Math.random()*W;}
    ctx.fillStyle=`rgba(200,180,140,${s.brightness+Math.sin(frameCount*0.03+s.x)*0.1})`; ctx.fillRect(Math.floor(s.x),Math.floor(s.y),s.size,s.size); });

  const grad = ctx.createLinearGradient(0, H-28, 0, H);
  grad.addColorStop(0,'#2a1c10'); grad.addColorStop(0.3,'#1a120a'); grad.addColorStop(1,'#0d0806');
  ctx.fillStyle = grad; ctx.fillRect(0, H-28, W, 28);
  ctx.strokeStyle = 'rgba(60,40,20,0.4)'; ctx.lineWidth = 1;
  for (let i=0;i<6;i++){const ly=H-26+i*4.5;ctx.beginPath();ctx.moveTo(0,ly);for(let x=0;x<W;x+=20)ctx.lineTo(x,ly+Math.sin(x*0.05+i));ctx.stroke();}
  ctx.fillStyle='rgba(200,160,100,0.2)'; ctx.fillRect(0,H-28,W,1);

  enemies.forEach(e => { if (!e.alive) return;
    if (e.hp<e.maxHp) ctx.globalAlpha=0.6+Math.sin(frameCount*0.3)*0.2;
    drawEnemy(e.type, e.x, e.y, e.frame); ctx.globalAlpha=1;
    if (e.maxHp>1&&e.hp<e.maxHp){const bw=e.w;ctx.fillStyle='rgba(255,0,0,0.5)';ctx.fillRect(e.x-bw/2,e.y+e.h/2+2,bw,2);ctx.fillStyle='rgba(57,255,20,0.7)';ctx.fillRect(e.x-bw/2,e.y+e.h/2+2,bw*(e.hp/e.maxHp),2);}
  });

  if (player.visible) drawPlayer(player.x, player.y);

  bullets.forEach(b => { ctx.save(); ctx.translate(b.x,b.y);
    ctx.fillStyle='#c0c0c0';ctx.beginPath();ctx.arc(0,0,3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ff2d7b';ctx.beginPath();ctx.arc(0,0,2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,45,123,0.3)';ctx.fillRect(-1,2,2,6);ctx.restore(); });

  enemyBullets.forEach(b => { ctx.fillStyle='#39ff14';ctx.beginPath();ctx.arc(b.x,b.y,3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ff2d7b';ctx.fillRect(b.x-1,b.y-1,2,2);
    ctx.fillStyle='rgba(57,255,20,0.2)';ctx.fillRect(b.x-1,b.y-b.vy*3,2,Math.abs(b.vy*3)); });

  powerups.forEach(p => { const pulse=Math.sin(p.frame*0.15)*3;
    ctx.fillStyle=p.color+'33';ctx.beginPath();ctx.arc(p.x,p.y,12+pulse,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=p.color+'88';ctx.fillRect(p.x-8,p.y-8,16,16);
    ctx.strokeStyle=p.color;ctx.lineWidth=1.5;ctx.strokeRect(p.x-8,p.y-8,16,16);
    ctx.fillStyle='#fff';ctx.font='12px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(p.label,p.x,p.y+1); });

  particles.forEach(p => { ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.fillRect(p.x-p.size/2,p.y-p.size/2,p.size,p.size); }); ctx.globalAlpha=1;

  ctx.textAlign='center'; ctx.textBaseline='middle';
  floatingTexts.forEach(t => { ctx.globalAlpha=t.life;ctx.fillStyle=t.color;ctx.font=`${t.size}px "Press Start 2P"`;ctx.fillText(t.text,t.x,t.y); }); ctx.globalAlpha=1;

  if (comboCount>1&&comboTimer>0){ctx.fillStyle=`rgba(255,234,0,${comboTimer/90*0.8})`;ctx.font='8px "Press Start 2P"';ctx.textAlign='right';ctx.fillText(`COMBO x${Math.min(comboCount,8)}`,W-10,H-34);}

  let iy=20; ctx.font='7px "Press Start 2P"'; ctx.textAlign='left';
  if (player.rapidFire){const a=player.rapidTimer<60?(Math.sin(frameCount*0.3)*0.5+0.5):1;ctx.globalAlpha=a;ctx.fillStyle='#ff2d7b';ctx.fillText('‚ö° RAPID',8,iy);iy+=12;}
  if (player.multiShot){const a=player.multiTimer<60?(Math.sin(frameCount*0.3)*0.5+0.5):1;ctx.globalAlpha=a;ctx.fillStyle='#00d4ff';ctx.fillText('‚ú¶ MULTI',8,iy);iy+=12;}
  if (player.shieldHP>0){ctx.globalAlpha=1;ctx.fillStyle='#39ff14';ctx.fillText('‚ô¶ SHIELD x'+player.shieldHP,8,iy);} ctx.globalAlpha=1;

  if (waveTransition>0){const a=waveTransition>60?(120-waveTransition)/60:waveTransition/60;ctx.globalAlpha=a;ctx.fillStyle='#ffea00';ctx.font='20px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(waveTransitionText,W/2,H/2);ctx.globalAlpha=1;}

  if (state==='paused'){ctx.fillStyle='rgba(10,8,6,0.7)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#ffea00';ctx.font='20px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('PAUSED',W/2,H/2);ctx.fillStyle='#8a7a5a';ctx.font='9px "Press Start 2P"';ctx.fillText('Press P to resume',W/2,H/2+30);}

  ctx.fillStyle='rgba(0,0,0,0.06)'; for(let y=0;y<H;y+=3) ctx.fillRect(0,y,W,1);
  const vg=ctx.createRadialGradient(W/2,H/2,H*0.4,W/2,H/2,H*0.9);vg.addColorStop(0,'transparent');vg.addColorStop(1,'rgba(0,0,0,0.4)');ctx.fillStyle=vg;ctx.fillRect(0,0,W,H);
  ctx.restore();
}

function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }

// ============================================================
// LEADERBOARD
// ============================================================
async function submitScore(name, scoreVal, waveVal) {
  const entry = { name: name.toUpperCase().substring(0,8), score: scoreVal, wave: waveVal, timestamp: Date.now() };
  if (firebaseReady) { try { await db.ref('barInvadersScores').push(entry); } catch(e) { saveLocalScore(entry); } }
  else saveLocalScore(entry);
  refreshLiveLeaderboard();
}
function saveLocalScore(entry) {
  const s = JSON.parse(localStorage.getItem('barInvadersScores')||'[]'); s.push(entry);
  s.sort((a,b)=>b.score-a.score); localStorage.setItem('barInvadersScores', JSON.stringify(s.slice(0,20)));
}
async function getLeaderboard() {
  if (firebaseReady) {
    try { const snap = await db.ref('barInvadersScores').orderByChild('score').limitToLast(20).once('value');
      const s=[]; snap.forEach(c=>s.push(c.val())); return s.sort((a,b)=>b.score-a.score);
    } catch(e) { return getLocalLeaderboard(); }
  }
  return getLocalLeaderboard();
}
function getLocalLeaderboard() { return JSON.parse(localStorage.getItem('barInvadersScores')||'[]').sort((a,b)=>b.score-a.score).slice(0,20); }

function renderLeaderboardRows(scores) {
  if (scores.length === 0) return '<div class="lb-empty">NO SCORES YET<br><br>BE THE FIRST!</div>';
  return scores.map((s, i) => `<div class="lb-row">
    <span class="lb-rank">${i+1}.</span><span class="lb-name">${s.name}</span>
    <span class="lb-score">${s.score.toLocaleString()}</span><span class="lb-wave">W${s.wave}</span></div>`).join('');
}

async function showLeaderboard(highlightName = null) {
  const scores = await getLeaderboard();
  document.getElementById('lb-table').innerHTML = scores.length === 0
    ? '<div style="text-align:center;padding:16px;color:#4a4a5a;font-family:\'Press Start 2P\';font-size:8px;">NO SCORES YET</div>'
    : scores.map((s,i) => {
      const hl = highlightName && s.name === highlightName.toUpperCase() ? ' highlight' : '';
      return `<div class="lb-row${hl}"><span class="lb-rank">${i+1}.</span><span class="lb-name">${s.name}</span><span class="lb-score">${s.score.toLocaleString()}</span><span class="lb-wave">W${s.wave}</span></div>`;
    }).join('');
  document.getElementById('title-panel').style.display = 'none';
  document.getElementById('game-over-panel').style.display = 'none';
  document.getElementById('leaderboard-panel').style.display = 'flex';
  document.getElementById('overlay').classList.remove('hidden');
}

// Live leaderboard below game
async function refreshLiveLeaderboard() {
  const el = document.getElementById('live-leaderboard');
  try {
    const scores = await getLeaderboard();
    el.innerHTML = renderLeaderboardRows(scores);
  } catch(e) {
    el.innerHTML = '<div class="lb-empty">COULD NOT LOAD SCORES</div>';
  }
}

// Firebase live listener for real-time updates
if (firebaseReady) {
  db.ref('barInvadersScores').orderByChild('score').limitToLast(20).on('value', snap => {
    const scores = []; snap.forEach(c => scores.push(c.val()));
    scores.sort((a,b) => b.score - a.score);
    document.getElementById('live-leaderboard').innerHTML = renderLeaderboardRows(scores);
  });
} else {
  refreshLiveLeaderboard();
}

// ============================================================
// UI EVENTS
// ============================================================
document.getElementById('start-btn').addEventListener('click', () => { audio.init(); resetGame(); state='playing'; document.getElementById('overlay').classList.add('hidden'); });
document.getElementById('submit-score-btn').addEventListener('click', async () => {
  const name = document.getElementById('player-name').value.trim()||'ANON';
  lastPlayerName=name; localStorage.setItem('barInvadersName',name);
  await submitScore(name, score, wave);
  audio.init(); resetGame(); state='playing'; document.getElementById('overlay').classList.add('hidden');
});
document.getElementById('view-lb-btn').addEventListener('click', async () => {
  const name = document.getElementById('player-name').value.trim()||'ANON';
  lastPlayerName=name; localStorage.setItem('barInvadersName',name);
  await submitScore(name, score, wave); await showLeaderboard(name);
});
document.getElementById('lb-play-btn').addEventListener('click', () => { audio.init(); resetGame(); state='playing'; document.getElementById('overlay').classList.add('hidden'); });
document.getElementById('lb-back-btn').addEventListener('click', () => {
  document.getElementById('leaderboard-panel').style.display='none';
  document.getElementById('title-panel').style.display='flex'; document.getElementById('title-panel').style.flexDirection='column'; document.getElementById('title-panel').style.alignItems='center';
});
document.getElementById('player-name').addEventListener('keydown', e => { if (e.key==='Enter') document.getElementById('submit-score-btn').click(); e.stopPropagation(); });
document.getElementById('player-name').addEventListener('keyup', e => e.stopPropagation());

gameLoop();
</script>
</body>
</html>
